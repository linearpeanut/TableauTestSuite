<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau Test Suite - Auto Installer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }
        h1 {
            color: #3b82f6;
            margin-bottom: 12px;
            font-size: 28px;
        }
        .subtitle {
            color: #94a3b8;
            margin-bottom: 32px;
            font-size: 14px;
        }
        .section {
            margin-bottom: 32px;
        }
        .section-title {
            color: #cbd5e1;
            font-weight: 600;
            margin-bottom: 16px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .steps {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .step {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        .step-number {
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .step-content {
            flex: 1;
        }
        .step-title {
            color: #f1f5f9;
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 13px;
        }
        .step-desc {
            color: #cbd5e1;
            font-size: 12px;
            line-height: 1.6;
        }
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #334155;
            color: #f1f5f9;
        }
        .btn-secondary:hover {
            background: #475569;
        }
        .code-block {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            color: #cbd5e1;
            overflow-x: auto;
            line-height: 1.6;
        }
        .info-box {
            background: #1e3a8a;
            border-left: 4px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            font-size: 12px;
            color: #bfdbfe;
        }
        .success-message {
            background: #064e3b;
            border-left: 4px solid #10b981;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            font-size: 12px;
            color: #d1fae5;
            display: none;
        }
        .success-message.show {
            display: block;
        }
        .feature-list {
            list-style: none;
            margin-top: 12px;
        }
        .feature-list li {
            color: #cbd5e1;
            font-size: 12px;
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
        }
        .feature-list li:before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Tableau Test Suite</h1>
        <p class="subtitle">One-click bookmark installation for dashboard validation</p>

        <div class="section">
            <div class="section-title">Installation Steps</div>
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">Right-click the button below</div>
                        <div class="step-desc">Click "Bookmark This Link" or "Add to Favorites" (varies by browser)</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">Name your bookmark</div>
                        <div class="step-desc">Use "Tableau Test Suite" or similar for easy identification</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-title">Save to your bookmarks bar</div>
                        <div class="step-desc">Choose "Bookmarks Bar" or "Favorites Bar" for quick access</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <div class="step-title">Navigate to any Tableau dashboard</div>
                        <div class="step-desc">Open the dashboard you want to test in your browser</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <div class="step-title">Click your new bookmark</div>
                        <div class="step-desc">The test suite will launch automatically on the dashboard</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">What You Get</div>
            <ul class="feature-list">
                <li>85+ automated validation tests</li>
                <li>Visual design & branding checks</li>
                <li>Data quality verification</li>
                <li>Performance analysis</li>
                <li>Accessibility compliance (WCAG)</li>
                <li>Security & privacy validation</li>
                <li>Reconciliation against spreadsheet data</li>
                <li>Exportable JSON reports</li>
            </ul>
        </div>

        <div class="section">
            <div class="section-title">Installation Link</div>
            <div class="info-box">
                ‚ö†Ô∏è <strong>Important:</strong> Right-click the button below and select "Bookmark This Link" or "Add to Favorites". Do NOT click it directly.
            </div>
            <div class="button-group">
                <a href="javascript:(function(){const CONFIG_STORAGE='tts:config',REPORT_STORAGE='tts:report',HIDDEN_STORAGE='tts:hidden',REGISTRY_STORAGE='tts:registry',RECONCILE_DATA='tts:reconcile:data',RECONCILE_CONFIG='tts:reconcile:config',CUSTOM_RULES='tts:custom:rules';const ls=localStorage,d=document,qs=d.querySelector.bind(d),qa=d.querySelectorAll.bind(d),ce=d.createElement.bind(d),gi=ls.getItem.bind(ls),si=ls.setItem.bind(ls),ri=ls.removeItem.bind(ls),jp=JSON.parse,js=JSON.stringify;const u=()=>window.crypto?.randomUUID?.()||'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{let r=Math.random()*16|0;return(c=='x'?r:(r&3|8)).toString(16)}),getConfig=()=>{try{return jp(gi(CONFIG_STORAGE)||'{}')}catch{return{}}},saveConfig=c=>si(CONFIG_STORAGE,js(c)),getReconcileConfig=()=>{try{return jp(gi(RECONCILE_CONFIG)||'[]')}catch{return[]}},saveReconcileConfig=c=>si(RECONCILE_CONFIG,js(c)),getReconcileData=()=>{try{return jp(gi(RECONCILE_DATA)||'{}')}catch{return{}}},saveReconcileData=d=>si(RECONCILE_DATA,js(d)),getCustomRules=()=>{try{return jp(gi(CUSTOM_RULES)||'{}')}catch{return{}}},saveCustomRules=r=>si(CUSTOM_RULES,js(r)),cs=a=>{let s=js(a),h=0,i=0,ln=s.length;for(;i<ln;i++)h=((h<<5)-h+s.charCodeAt(i))|0;return h},parseSpreadsheet=async file=>{if(!file)return null;const ext=file.name.split('.').pop().toLowerCase();if(ext==='csv'){const text=await file.text();return parseCSV(text)}else if(ext==='xlsx'){if(!window.XLSX){const script=ce('script');script.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';await new Promise((res,rej)=>{script.onload=res;script.onerror=rej;d.body.appendChild(script)});await new Promise(r=>setTimeout(r,500))}const ab=await file.arrayBuffer();const wb=window.XLSX.read(ab);const ws=wb.Sheets[wb.SheetNames[0]];return window.XLSX.utils.sheet_to_json(ws)}return null},parseCSV=text=>{const lines=text.trim().split('\n');const headers=lines[0].split(',').map(h=>h.trim());const data=[];for(let i=1;i<lines.length;i++){const obj={};const values=lines[i].split(',').map(v=>v.trim());headers.forEach((h,idx)=>obj[h]=values[idx]);data.push(obj)}return data},reconcileData=async()=>{const config=getReconcileConfig();if(!config.length){return{status:'warn',message:'No reconciliation config loaded',details:[]}}const viz=window.tableau?.VizManager?.getVizs?.()?.[0];if(!viz){return{status:'fail',message:'No Tableau viz detected',details:[]}}const results=[];for(let rule of config){try{const ws=viz.getWorkbook().getActiveSheet().getWorksheets().find(w=>w.getName()===rule.worksheet);if(!ws){results.push({rule:rule.name,status:'fail',message:'Worksheet not found: '+rule.worksheet});continue}const summary=await ws.getSummaryDataAsync();const cols=summary.getColumns().map(c=>c.getFieldName());const data=summary.getData();let found=!1;for(let row of data){const rowData={};cols.forEach((c,i)=>rowData[c]=row[i]?.value);if(rule.dimension&&rowData[rule.dimension]!==rule.dimensionValue)continue;const measure=rowData[rule.measure];const expected=parseFloat(rule.expectedValue);const tolerance=parseFloat(rule.tolerance||0);const actual=parseFloat(measure);const diff=Math.abs(actual-expected);const passed=diff<=tolerance;results.push({rule:rule.name,worksheet:rule.worksheet,dimension:rule.dimension,measure:rule.measure,expected:expected,actual:actual,tolerance:tolerance,diff:diff,status:passed?'pass':'fail',message:passed?'Value matches':'Value mismatch'});found=!0;break}if(!found){results.push({rule:rule.name,status:'fail',message:'No matching row found'})}}catch(e){results.push({rule:rule.name,status:'fail',message:'Error: '+e.message})}}const passed=results.filter(r=>r.status==='pass').length;const failed=results.filter(r=>r.status==='fail').length;return{status:failed===0?'pass':'fail',message:passed+' passed, '+failed+' failed',details:results}},testParameterDimensionConnection=async()=>{const viz=window.tableau?.VizManager?.getVizs?.()?.[0];if(!viz)return{status:'fail',label:'Parameter-Dimension Connection',details:'No viz detected'};const workbook=viz.getWorkbook();const params=workbook.getParametersAsync?await workbook.getParametersAsync():[];const results=[];for(let param of params){try{const paramName=param.getName();const paramDomain=param.getAllowableValuesType?.();const isDimensionDomain=paramDomain==='all'||paramDomain==='list';if(!isDimensionDomain){results.push({param:paramName,status:'info',message:'Parameter has fixed domain'});continue}const sheets=viz.getWorkbook().getActiveSheet().getWorksheets?.();if(!sheets){results.push({param:paramName,status:'warn',message:'Cannot verify dimension connection'});continue}let connected=!1;for(let sheet of sheets){try{const summary=await sheet.getSummaryDataAsync();const cols=summary.getColumns().map(c=>c.getFieldName());if(cols.some(c=>c.includes(paramName)||paramName.includes(c))){connected=!0;break}}catch(e){}}results.push({param:paramName,status:connected?'pass':'warn',message:connected?'Dimension connection verified':'Could not verify dimension connection'})}catch(e){results.push({param:param.getName?.(),status:'fail',message:'Error: '+e.message})}}return{status:results.some(r=>r.status==='fail')?'fail':'pass',label:'Parameter-Dimension Connection',details:results.map(r=>r.param+': '+r.message).join('; ')}},testSuite={results:[],passed:0,failed:0,warnings:0,info:0,startTime:Date.now(),reconciliationResults:null,parameterTests:null};const createUI=()=>{qs('#tts-main')?.remove();const ui=ce('div');ui.id='tts-main';ui.innerHTML='<style>#tts-main{position:fixed;top:10px;right:10px;width:480px;max-height:95vh;background:#0f172a;color:#f1f5f9;border-radius:16px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.7);z-index:2147483647;font:14px system-ui,sans-serif;display:flex;flex-direction:column;border:1px solid #334155;font-family:system-ui,Arial,sans-serif}#tts-head{background:linear-gradient(135deg,#1e3a8a,#3b82f6);padding:16px 20px;display:flex;justify-content:space-between;align-items:center;border-radius:16px 16px 0 0;cursor:move;user-select:none}#tts-title{font-size:17px;font-weight:700;margin:0;color:#fff}#tts-close{background:rgba(255,255,255,0.1);border:none;color:#fff;cursor:pointer;width:32px;height:32px;border-radius:8px;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all .2s}#tts-close:hover{background:rgba(255,255,255,0.2)}#tts-progress{height:3px;background:#1e293b}#tts-progress-bar{height:100%;background:linear-gradient(90deg,#10b981,#3b82f6);width:0;transition:width .3s}#tts-nav{display:flex;background:#1e293b;border-bottom:1px solid #334155;overflow-x:auto}#tts-nav button{flex:1;min-width:90px;padding:12px 8px;background:none;border:none;color:#94a3b8;cursor:pointer;font-size:11px;font-weight:600;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap}#tts-nav button:hover{color:#f1f5f9;background:#334155}#tts-nav button.active{color:#3b82f6;border-bottom-color:#3b82f6;background:#0f172a}#tts-body{padding:16px;overflow-y:auto;flex:1;background:#1e293b}#tts-footer{padding:12px 16px;background:#0f172a;border-top:1px solid #334155;display:flex;gap:8px;border-radius:0 0 16px 16px;flex-wrap:wrap}#tts-footer button{padding:10px 12px;border:none;border-radius:8px;cursor:pointer;font-size:11px;font-weight:600;transition:all .2s;flex:1;min-width:70px}.tts-btn-primary{background:#3b82f6;color:#fff}.tts-btn-primary:hover{background:#2563eb;transform:translateY(-1px)}.tts-btn-secondary{background:#334155;color:#f1f5f9}.tts-btn-secondary:hover{background:#475569}.tts-section{margin-bottom:16px}.tts-section-title{font-size:13px;font-weight:700;color:#cbd5e1;margin:0 0 10px;padding:8px 12px;background:#0f172a;border-radius:8px;border-left:4px solid #3b82f6}.tts-item{display:flex;gap:10px;padding:10px 12px;margin:6px 0;border-radius:8px;font-size:12px;line-height:1.5;border-left:4px solid}.tts-item.pass{background:#064e3b;border-color:#10b981;color:#d1fae5}.tts-item.fail{background:#7f1d1d;border-color:#ef4444;color:#fecaca}.tts-item.warn{background:#78350f;border-color:#f59e0b;color:#fed7aa}.tts-item.info{background:#1e3a8a;border-color:#3b82f6;color:#bfdbfe}.tts-icon{font-size:14px;margin-top:2px}.tts-label{font-weight:600;display:block;margin-bottom:2px}.tts-desc{font-size:10px;opacity:.85;line-height:1.4}.tts-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}.tts-card{background:#0f172a;padding:14px;border-radius:10px;text-align:center;border:1px solid #334155}.tts-card-value{font-size:28px;font-weight:700;margin-bottom:4px}.tts-card.pass .tts-card-value{color:#10b981}.tts-card.fail .tts-card-value{color:#ef4444}.tts-card.warn .tts-card-value{color:#f59e0b}.tts-card.info .tts-card-value{color:#3b82f6}.tts-card-label{font-size:9px;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;font-weight:600}.tts-metric{display:flex;justify-content:space-between;padding:8px;background:#0f172a;border-radius:6px;margin:4px 0;font-size:11px}.tts-metric-label{color:#94a3b8}.tts-metric-value{color:#f1f5f9;font-weight:600}.tts-tab-content{display:none}.tts-tab-content.active{display:block}.tts-badge{display:inline-block;background:#334155;color:#f1f5f9;padding:3px 8px;border-radius:12px;font-size:9px;font-weight:700;margin-left:6px}.tts-form-group{margin-bottom:12px}.tts-form-label{display:block;font-size:11px;font-weight:600;color:#cbd5e1;margin-bottom:4px}.tts-form-input{width:100%;padding:6px 8px;background:#0f172a;border:1px solid #334155;border-radius:4px;color:#f1f5f9;font-size:11px}.tts-form-input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,0.1)}.tts-file-input{display:none}.tts-file-btn{display:inline-block;padding:6px 12px;background:#3b82f6;color:#fff;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600}.tts-file-btn:hover{background:#2563eb}.tts-table{width:100%;border-collapse:collapse;font-size:10px;margin:8px 0}.tts-table th{background:#0f172a;padding:6px;text-align:left;font-weight:600;color:#cbd5e1;border-bottom:1px solid #334155}.tts-table td{padding:6px;border-bottom:1px solid #334155;color:#f1f5f9}.tts-table tr:hover{background:#334155}</style><div id="tts-head"><h3 id="tts-title">Tableau Test Suite v0.1Œ±</h3><button id="tts-close">√ó</button></div><div id="tts-progress"><div id="tts-progress-bar"></div></div><div id="tts-nav"><button class="active" data-tab="summary">Summary</button><button data-tab="visual">Visual</button><button data-tab="data">Data</button><button data-tab="functional">Functional</button><button data-tab="technical">Technical</button><button data-tab="reconcile">Reconcile</button><button data-tab="config">Config</button></div><div id="tts-body"><div id="tab-summary" class="tts-tab-content active"></div><div id="tab-visual" class="tts-tab-content"></div><div id="tab-data" class="tts-tab-content"></div><div id="tab-functional" class="tts-tab-content"></div><div id="tab-technical" class="tts-tab-content"></div><div id="tab-reconcile" class="tts-tab-content"></div><div id="tab-config" class="tts-tab-content"></div></div><div id="tts-footer"><button class="tts-btn-primary" id="btn-run">‚ñ∂ Run Tests</button><button class="tts-btn-secondary" id="btn-export">‚§ì Export</button></div>';d.body.appendChild(ui);setupDragAndDrop();setupNavigation();setupButtons()},setupDragAndDrop=()=>{const head=qs('#tts-head'),panel=qs('#tts-main');let isDragging=!1,offsetX=0,offsetY=0;head.addEventListener('mousedown',e=>{isDragging=!0;const rect=panel.getBoundingClientRect();offsetX=e.clientX-rect.left;offsetY=e.clientY-rect.top});d.addEventListener('mousemove',e=>{if(isDragging){panel.style.left=(e.clientX-offsetX)+'px';panel.style.top=(e.clientY-offsetY)+'px'}});d.addEventListener('mouseup',()=>isDragging=!1)},setupNavigation=()=>{qa('#tts-nav button').forEach(btn=>{btn.addEventListener('click',()=>{qa('#tts-nav button').forEach(b=>b.classList.remove('active'));btn.classList.add('active');qa('.tts-tab-content').forEach(c=>c.classList.remove('active'));const tabId='tab-'+btn.dataset.tab;qs('#'+tabId).classList.add('active')})})},setupButtons=()=>{qs('#tts-close').addEventListener('click',()=>qs('#tts-main')?.remove());qs('#btn-run').addEventListener('click',runAllTests);qs('#btn-export').addEventListener('click',exportReport)},updateProgress=pct=>{qs('#tts-progress-bar').style.width=pct+'%'},addTest=(cat,status,label,details,recommendation='')=>{testSuite.results.push({category:cat,status,label,details,recommendation,timestamp:Date.now()-testSuite.startTime});testSuite[status==='pass'?'passed':status==='fail'?'failed':status==='warn'?'warnings':'info']++},runAllTests=async()=>{testSuite.results=[];testSuite.passed=testSuite.failed=testSuite.warnings=testSuite.info=0;testSuite.startTime=Date.now();updateProgress(5);await testDeploymentIntegrity();updateProgress(15);await testVersionControl();updateProgress(25);await testVisualDesign();updateProgress(40);await testDataValidation();updateProgress(55);await testFunctionalTests();updateProgress(70);await testPerformance();updateProgress(85);await testAccessibility();updateProgress(95);await testSecurity();updateProgress(98);testSuite.parameterTests=await testParameterDimensionConnection();addTest('data',testSuite.parameterTests.status,testSuite.parameterTests.label,testSuite.parameterTests.details);testSuite.reconciliationResults=await reconcileData();updateProgress(100);renderResults()},testDeploymentIntegrity=async()=>{const dashboards=d.querySelectorAll('[data-tb-test-id*="dashboard"],.tableau-dashboard,.tab-dashboard');addTest('deployment',dashboards.length>0?'pass':'fail','Component Dashboards Detected',dashboards.length+' dashboard component(s) found',dashboards.length===0?'Verify Tableau dashboard is fully loaded':'');const containers=d.querySelectorAll('.tabContainerFrame,iframe[src*="tableau"]');addTest('deployment',containers.length>0?'info':'warn','Container HTML Detection',containers.length+' container(s) detected',containers.length===0?'Check if using embedded container HTML':'');const testFlags=Array.from(d.querySelectorAll('*')).filter(el=>el.textContent.toLowerCase().includes('test')||el.className.toLowerCase().includes('test'));addTest('deployment',testFlags.length<5?'pass':'warn','Test Flag Check',testFlags.length+' potential test flag(s) found',testFlags.length>=5?'Review for test flags in titles/classes':'')},testVersionControl=async()=>{const versionElements=Array.from(d.querySelectorAll('*')).filter(el=>/v?\d+\.\d+(\.\d+)?/i.test(el.textContent));const versions=new Set(versionElements.map(el=>el.textContent.match(/v?\d+\.\d+(\.\d+)?/i)?.[0]));addTest('version',versions.size<=1?'pass':'warn','Version Consistency',versions.size<=1?'Single version detected':'Multiple versions found: '+Array.from(versions).join(', '),versions.size>1?'Ensure all components have same version number':'');const testLabels=d.querySelectorAll('[title*="test" i],[aria-label*="test" i]');addTest('version',testLabels.length===0?'pass':'warn','Test Labels in Production',testLabels.length===0?'No test labels found':testLabels.length+' test label(s) detected',testLabels.length>0?'Remove test flags from production':'')},testVisualDesign=async()=>{const allElements=d.querySelectorAll('*');const fonts=new Set();const fontSizes=new Set();allElements.forEach(el=>{const style=window.getComputedStyle(el);fonts.add(style.fontFamily);fontSizes.add(style.fontSize)});addTest('visual',fonts.size<=5?'pass':'warn','Font Consistency',fonts.size+' unique font families',fonts.size>5?'Consider consolidating to brand fonts':'');const margins=[];const paddings=[];d.querySelectorAll('.tab-widget,.tableau-viz').forEach(el=>{const style=window.getComputedStyle(el);margins.push(parseInt(style.marginTop)||0);paddings.push(parseInt(style.paddingTop)||0)});const marginVariance=margins.length>0?Math.max(...margins)-Math.min(...margins):0;addTest('visual',marginVariance<=8?'pass':'warn','Margin Alignment','Max variance: '+marginVariance+'px',marginVariance>8?'Check vertical alignment consistency':'');const colors=new Set();d.querySelectorAll('[fill],[stroke],[style*="color"],[style*="background"]').forEach(el=>{const fill=el.getAttribute('fill');const stroke=el.getAttribute('stroke');const style=window.getComputedStyle(el);if(fill&&fill!=='none')colors.add(fill);if(stroke&&stroke!=='none')colors.add(stroke);colors.add(style.color);colors.add(style.backgroundColor)});addTest('visual',colors.size<50?'pass':'info','Color Palette',colors.size+' unique colors detected','Review against brand guidelines');const tooltips=d.querySelectorAll('[data-tb-test-id*="tooltip"],.tableau-tooltip');const enabledTooltips=Array.from(tooltips).filter(tt=>!tt.hasAttribute('disabled')&&window.getComputedStyle(tt).display!=='none');addTest('visual',enabledTooltips.length<tooltips.length*0.3?'pass':'warn','Tooltip Usage',enabledTooltips.length+'/'+tooltips.length+' tooltips enabled',enabledTooltips.length>tooltips.length*0.5?'Consider disabling redundant tooltips':'');const headings=d.querySelectorAll('h1,h2,h3,h4,h5,h6,[role="heading"]');addTest('visual',headings.length>0?'pass':'warn','Typography Hierarchy',headings.length+' heading(s) found',headings.length===0?'Add proper heading structure':'');const allText=Array.from(d.querySelectorAll('*')).map(el=>el.textContent).join(' ');const typos=['teh ','recieve','occured','thier','seperate'];const foundTypos=typos.filter(t=>allText.toLowerCase().includes(t));addTest('visual',foundTypos.length===0?'pass':'warn','Spelling Check',foundTypos.length===0?'No common typos found':'Potential typos: '+foundTypos.join(', '),foundTypos.length>0?'Run spell check on all text':'');const thumbnails=d.querySelectorAll('[data-tb-test-id*="thumbnail"],img[src*="thumb"]');addTest('visual',thumbnails.length>0?'info':'warn','Dashboard Thumbnails',thumbnails.length+' thumbnail(s) found',thumbnails.length===0?'Verify thumbnails are updated':'')},testDataValidation=async()=>{const tables=d.querySelectorAll('table,[role="table"],.tabular-data');addTest('data',tables.length>0?'pass':'info','Data Tables Detected',tables.length+' table(s) found');const cells=d.querySelectorAll('td,[role="cell"]');const nullCells=Array.from(cells).filter(c=>{const t=c.textContent.trim().toLowerCase();return t==='null'||t==='n/a'||t===''||t==='#n/a'||t==='nan'});addTest('data',nullCells.length<cells.length*0.05?'pass':'warn','Null Value Handling',nullCells.length+'/'+cells.length+' cells with null/empty values',nullCells.length>cells.length*0.05?'Review null handling logic':'');const errorIndicators=d.querySelectorAll('.error,.alert,[class*="error"],[data-tb-test-id*="error"],.tab-error');addTest('data',errorIndicators.length===0?'pass':'fail','Error Indicators',errorIndicators.length===0?'No errors detected':errorIndicators.length+' error(s) found',errorIndicators.length>0?'Investigate and resolve errors':'');const hashErrors=Array.from(cells).filter(c=>c.textContent.includes('#####'));addTest('data',hashErrors.length===0?'pass':'fail','Column Width Issues',hashErrors.length===0?'No ##### errors':'Found '+hashErrors.length+' ##### error(s)',hashErrors.length>0?'Increase column widths':'');const filters=d.querySelectorAll('[data-tb-test-id*="filter"],.tab-filter,.filter-container,select[name*="filter"]');addTest('data',filters.length>0?'pass':'info','Filter Controls',filters.length+' filter(s) detected');const duplicateFilters=d.querySelectorAll('.tab-filter');const filterTexts=Array.from(duplicateFilters).map(f=>f.textContent);const hasDupes=filterTexts.length!==new Set(filterTexts).size;addTest('data',!hasDupes?'pass':'warn','Duplicate Filters',hasDupes?'Duplicate filters detected':'No duplicate filters',hasDupes?'Remove duplicate filters on worksheets':'');const params=d.querySelectorAll('[data-tb-test-id*="parameter"],input[name*="param"],.parameter-control');addTest('data',params.length>0?'info':'info','Parameters',params.length+' parameter control(s)');const dateElements=Array.from(d.querySelectorAll('*')).filter(el=>/\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}/.test(el.textContent));addTest('data',dateElements.length>0?'info':'warn','Date Display',dateElements.length+' element(s) with date format',dateElements.length===0?'Verify date fields are displaying':'');const lastRefresh=Array.from(d.querySelectorAll('*')).find(el=>el.textContent.toLowerCase().includes('last refresh')||el.textContent.toLowerCase().includes('as of')||el.textContent.toLowerCase().includes('updated'));addTest('data',lastRefresh?'pass':'warn','Data Refresh Indicator',lastRefresh?'Refresh indicator found':'No refresh indicator',!lastRefresh?'Add last refresh date/time to dashboard':'');const kpis=d.querySelectorAll('[class*="kpi"],[data-tb-test-id*="kpi"],.metric-card');addTest('data',kpis.length>0?'info':'info','KPI Elements',kpis.length+' KPI element(s) detected')},testFunctionalTests=async()=>{const exportButtons=d.querySelectorAll('[title*="download" i],[aria-label*="download" i],[title*="export" i],[data-tb-test-id*="download"]');addTest('functional',exportButtons.length>0?'pass':'warn','Export Functionality',exportButtons.length+' export button(s) found',exportButtons.length===0?'Verify export functionality is available':'');const printButtons=d.querySelectorAll('[title*="print" i],[onclick*="print"]');addTest('functional',printButtons.length>0?'pass':'info','Print Functionality',printButtons.length+' print button(s) found');const saveViewButtons=d.querySelectorAll('[title*="save" i],[title*="custom view" i]');addTest('functional',saveViewButtons.length>0?'pass':'info','Custom View Save',saveViewButtons.length+' save view button(s) found');const feedbackButtons=d.querySelectorAll('[title*="feedback" i],[aria-label*="feedback" i]');addTest('functional',feedbackButtons.length>0?'pass':'info','Feedback Tools',feedbackButtons.length+' feedback button(s) found');const navButtons=d.querySelectorAll('button,[role="button"],a[href*="#"],.nav-button');addTest('functional',navButtons.length>0?'pass':'info','Interactive Elements',navButtons.length+' interactive element(s)');const forms=d.querySelectorAll('form');forms.forEach((form,i)=>{const requiredFields=form.querySelectorAll('[required]');addTest('functional',requiredFields.length>0?'pass':'info','Form '+i+' Required Fields',requiredFields.length+' required field(s)')});const hamburger=d.querySelectorAll('[class*="hamburger"],[class*="menu-icon"]');addTest('functional',hamburger.length>0?'pass':'info','Navigation Menu',hamburger.length+' menu icon(s) found');const dropdowns=d.querySelectorAll('select,.dropdown,select[multiple]');addTest('functional',dropdowns.length>0?'info':'info','Dropdown Controls',dropdowns.length+' dropdown(s) detected');const links=d.querySelectorAll('a[href]');const brokenLinks=Array.from(links).filter(l=>l.href==='#'||l.href.endsWith('#'));addTest('functional',brokenLinks.length<links.length*0.1?'pass':'warn','Link Integrity',brokenLinks.length+'/'+links.length+' placeholder links',brokenLinks.length>links.length*0.1?'Update placeholder links':'')},testPerformance=async()=>{const timing=performance.timing;const loadTime=timing.loadEventEnd-timing.navigationStart;const domReady=timing.domContentLoadedEventEnd-timing.navigationStart;addTest('technical',loadTime<5000?'pass':'warn','Page Load Time',loadTime+'ms',loadTime>=5000?'Optimize for load time <5s':'');addTest('technical',domReady<3000?'pass':'warn','DOM Ready Time',domReady+'ms',domReady>=3000?'Optimize DOM construction':'');const images=d.querySelectorAll('img');const brokenImages=Array.from(images).filter(img=>!img.complete||img.naturalHeight===0);addTest('technical',brokenImages.length===0?'pass':'fail','Image Loading',brokenImages.length===0?'All images loaded':brokenImages.length+' broken image(s)',brokenImages.length>0?'Fix broken image sources':'');const scripts=d.querySelectorAll('script[src]');const scriptCount=scripts.length;addTest('technical',scriptCount<30?'pass':'warn','External Scripts',scriptCount+' external script(s)',scriptCount>=30?'Consider script consolidation':'');const styleSheets=d.styleSheets.length;addTest('technical',styleSheets<20?'pass':'warn','Stylesheets',styleSheets+' stylesheet(s)',styleSheets>=20?'Consider CSS consolidation':'');const isDev=window.location.hostname.includes('local')||window.location.hostname.includes('dev')||window.location.hostname.includes('test')||window.location.hostname.includes('stage');addTest('technical',!isDev?'pass':'warn','Environment Detection',isDev?'Non-production environment':'Production environment',isDev?'Verify this is correct environment':'');const tableauAPI=typeof tableau!=='undefined'||d.querySelector('[src*="tableau"]');addTest('technical',tableauAPI?'pass':'fail','Tableau API',tableauAPI?'Tableau detected':'Tableau not detected',!tableauAPI?'Verify Tableau is properly loaded':'')},testAccessibility=async()=>{const images=d.querySelectorAll('img');const imagesNoAlt=Array.from(images).filter(img=>!img.alt||img.alt.trim()==='');addTest('accessibility',imagesNoAlt.length===0?'pass':'fail','Image Alt Text',imagesNoAlt.length+'/'+images.length+' images missing alt',imagesNoAlt.length>0?'Add alt text to all images':'');const buttons=d.querySelectorAll('button,[role="button"]');const buttonsNoLabel=Array.from(buttons).filter(btn=>!btn.textContent.trim()&&!btn.getAttribute('aria-label')&&!btn.getAttribute('title'));addTest('accessibility',buttonsNoLabel.length===0?'pass':'warn','Button Labels',buttonsNoLabel.length+'/'+buttons.length+' buttons without labels',buttonsNoLabel.length>0?'Add aria-label or title to buttons':'');const focusable=d.querySelectorAll('a,button,input,select,textarea,[tabindex]');addTest('accessibility',focusable.length>0?'pass':'warn','Keyboard Navigation',focusable.length+' focusable element(s)',focusable.length===0?'Ensure keyboard navigation support':'');const landmarks=d.querySelectorAll('[role="main"],[role="navigation"],[role="banner"],main,nav,header');addTest('accessibility',landmarks.length>0?'pass':'warn','ARIA Landmarks',landmarks.length+' landmark(s) found',landmarks.length===0?'Add semantic HTML/ARIA landmarks':'');const headings=d.querySelectorAll('h1,h2,h3,h4,h5,h6');const h1Count=d.querySelectorAll('h1').length;addTest('accessibility',h1Count===1?'pass':'warn','Heading Structure',h1Count+' H1 heading(s)',h1Count!==1?'Ensure single H1 per page':'');const contrastIssues=[];d.querySelectorAll('*').forEach(el=>{const style=window.getComputedStyle(el);const bg=style.backgroundColor;const fg=style.color;if(fg&&bg&&bg!=='rgba(0, 0, 0, 0)'){const contrast=getContrastRatio(fg,bg);if(contrast<4.5&&el.textContent.trim())contrastIssues.push(el)}});addTest('accessibility',contrastIssues.length<10?'pass':'warn','Color Contrast','~'+contrastIssues.length+' potential contrast issues',contrastIssues.length>=10?'Review color contrast ratios (WCAG 4.5:1)':'')},testSecurity=async()=>{const sensitiveTerms=['ssn','password','credit card','api key','secret'];const foundSensitive=sensitiveTerms.filter(term=>d.body.textContent.toLowerCase().includes(term));addTest('security',foundSensitive.length===0?'pass':'warn','Sensitive Data Exposure',foundSensitive.length===0?'No obvious sensitive terms':'Found: '+foundSensitive.join(', '),foundSensitive.length>0?'Verify sensitive data is protected':'');const httpsUrls=Array.from(d.querySelectorAll('[src],[href]')).map(el=>el.src||el.href).filter(url=>url.startsWith('http://'));addTest('security',httpsUrls.length===0?'pass':'warn','HTTPS Usage',httpsUrls.length+' non-HTTPS URLs',httpsUrls.length>0?'Use HTTPS for all resources':'');const externalLinks=Array.from(d.querySelectorAll('a[href]')).filter(a=>a.hostname&&a.hostname!==window.location.hostname);addTest('security',externalLinks.length<20?'pass':'info','External Links',externalLinks.length+' external link(s)');const iframes=d.querySelectorAll('iframe');const sandboxedIframes=Array.from(iframes).filter(f=>f.hasAttribute('sandbox'));addTest('security',sandboxedIframes.length===iframes.length?'pass':'warn','Iframe Security',sandboxedIframes.length+'/'+iframes.length+' iframes sandboxed',sandboxedIframes.length<iframes.length?'Consider sandboxing iframes':'')},getContrastRatio=(fg,bg)=>{const getLuminance=color=>{const rgb=color.match(/\d+/g);if(!rgb||rgb.length<3)return 0;const[r,g,b]=rgb.map(v=>v/255).map(v=>v<=0.03928?v/12.92:Math.pow((v+0.055)/1.055,2.4));return 0.2126*r+0.7152*g+0.0722*b};const l1=getLuminance(fg);const l2=getLuminance(bg);const lighter=Math.max(l1,l2);const darker=Math.min(l1,l2);return(lighter+0.05)/(darker+0.05)},renderResults=()=>{const categories={deployment:[],version:[],visual:[],data:[],functional:[],technical:[],accessibility:[],security:[]};testSuite.results.forEach(r=>{if(categories[r.category])categories[r.category].push(r)});const summary='<div class="tts-summary"><div class="tts-card pass"><div class="tts-card-value">'+testSuite.passed+'</div><div class="tts-card-label">Passed</div></div><div class="tts-card fail"><div class="tts-card-value">'+testSuite.failed+'</div><div class="tts-card-label">Failed</div></div><div class="tts-card warn"><div class="tts-card-value">'+testSuite.warnings+'</div><div class="tts-card-label">Warnings</div></div><div class="tts-card info"><div class="tts-card-value">'+testSuite.info+'</div><div class="tts-card-label">Info</div></div></div><div class="tts-metric"><span class="tts-metric-label">Total Tests</span><span class="tts-metric-value">'+(testSuite.passed+testSuite.failed+testSuite.warnings+testSuite.info)+'</span></div><div class="tts-metric"><span class="tts-metric-label">Execution Time</span><span class="tts-metric-value">'+((Date.now()-testSuite.startTime)/1000).toFixed(2)+'s</span></div><div class="tts-metric"><span class="tts-metric-label">Success Rate</span><span class="tts-metric-value">'+Math.round(testSuite.passed/(testSuite.passed+testSuite.failed+testSuite.warnings)*100)+'%</span></div>';qs('#tab-summary').innerHTML=summary+'<div class="tts-section"><h4 class="tts-section-title">Critical Issues</h4>'+(testSuite.failed===0?'<div class="tts-item pass"><span class="tts-icon">‚úì</span><div><div class="tts-label">No Critical Issues</div><div class="tts-desc">All critical tests passed</div></div></div>':testSuite.results.filter(r=>r.status==='fail').map(r=>'<div class="tts-item fail"><span class="tts-icon">‚úó</span><div><div class="tts-label">'+r.label+'</div><div class="tts-desc">'+r.details+(r.recommendation?' - '+r.recommendation:'')+'</div></div></div>').join(''))+'</div>';const renderCategory=(cat,title)=>{const tests=categories[cat];if(!tests||tests.length===0)return'';return'<div class="tts-section"><h4 class="tts-section-title">'+title+'<span class="tts-badge">'+tests.length+'</span></h4>'+tests.map(t=>'<div class="tts-item '+t.status+'"><span class="tts-icon">'+(t.status==='pass'?'‚úì':t.status==='fail'?'‚úó':t.status==='warn'?'‚ö†':'‚Ñπ')+'</span><div><div class="tts-label">'+t.label+'</div><div class="tts-desc">'+t.details+(t.recommendation?' <strong>‚Üí</strong> '+t.recommendation:'')+'</div></div></div>').join('')+'</div>'};qs('#tab-visual').innerHTML=renderCategory('visual','Visual Design & Branding');qs('#tab-data').innerHTML=renderCategory('data','Data Quality & Validation')+renderCategory('deployment','Deployment Integrity')+renderCategory('version','Version Control');qs('#tab-functional').innerHTML=renderCategory('functional','Functionality & Interactivity');qs('#tab-technical').innerHTML=renderCategory('technical','Performance & Technical')+renderCategory('accessibility','Accessibility')+renderCategory('security','Security & Privacy');renderReconcileTab();renderConfigTab()},renderReconcileTab=()=>{const results=testSuite.reconciliationResults;if(!results){qs('#tab-reconcile').innerHTML='<div class="tts-section"><h4 class="tts-section-title">Reconciliation</h4><p style="color:#94a3b8;font-size:11px">No reconciliation data loaded. Upload a CSV or XLSX file in the Config tab.</p></div>';return}const html='<div class="tts-section"><h4 class="tts-section-title">Reconciliation Results</h4><div class="tts-metric"><span class="tts-metric-label">Status</span><span class="tts-metric-value">'+results.status.toUpperCase()+'</span></div><div class="tts-metric"><span class="tts-metric-label">Summary</span><span class="tts-metric-value">'+results.message+'</span></div></div>';if(results.details.length>0){const table='<table class="tts-table"><thead><tr><th>Rule</th><th>Status</th><th>Message</th></tr></thead><tbody>'+results.details.map(d=>'<tr><td>'+d.rule+'</td><td>'+d.status+'</td><td>'+d.message+'</td></tr>').join('')+'</tbody></table>';qs('#tab-reconcile').innerHTML=html+'<div class="tts-section">'+table+'</div>'}else{qs('#tab-reconcile').innerHTML=html}},renderConfigTab=()=>{const config=getReconcileConfig();const html='<div class="tts-section"><h4 class="tts-section-title">Reconciliation Config</h4><div class="tts-form-group"><label class="tts-form-label">Upload Reconciliation File (CSV or XLSX)</label><input type="file" id="reconcile-file" class="tts-file-input" accept=".csv,.xlsx"><label for="reconcile-file" class="tts-file-btn">Choose File</label><div id="file-status" style="margin-top:8px;font-size:10px;color:#94a3b8"></div></div></div>';if(config.length>0){const table='<div class="tts-section"><h4 class="tts-section-title">Loaded Rules ('+config.length+')</h4><table class="tts-table"><thead><tr><th>Name</th><th>Worksheet</th><th>Measure</th></tr></thead><tbody>'+config.map(c=>'<tr><td>'+c.name+'</td><td>'+c.worksheet+'</td><td>'+c.measure+'</td></tr>').join('')+'</tbody></table></div>';qs('#tab-config').innerHTML=html+table}else{qs('#tab-config').innerHTML=html}const fileInput=qs('#reconcile-file');if(fileInput){fileInput.addEventListener('change',async e=>{const file=e.target.files[0];if(!file){qs('#file-status').textContent='No file selected';return}try{const data=await parseSpreadsheet(file);if(!data){qs('#file-status').textContent='Error: Could not parse file';return}saveReconcileConfig(data);qs('#file-status').textContent='‚úì Loaded '+data.length+' rules';renderConfigTab()}catch(err){qs('#file-status').textContent='Error: '+err.message}})}}},exportReport=()=>{const report={metadata:{timestamp:new Date().toISOString(),url:window.location.href,userAgent:navigator.userAgent,executionTime:Date.now()-testSuite.startTime},summary:{total:testSuite.passed+testSuite.failed+testSuite.warnings+testSuite.info,passed:testSuite.passed,failed:testSuite.failed,warnings:testSuite.warnings,info:testSuite.info,successRate:Math.round(testSuite.passed/(testSuite.passed+testSuite.failed+testSuite.warnings)*100)},results:testSuite.results,reconciliation:testSuite.reconciliationResults,parameterTests:testSuite.parameterTests,recommendations:testSuite.results.filter(r=>r.recommendation).map(r=>({test:r.label,recommendation:r.recommendation}))};const blob=new Blob([js(report,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=ce('a');a.href=url;a.download='tableau-test-report-'+Date.now()+'.json';d.body.appendChild(a);a.click();d.body.removeChild(a);URL.revokeObjectURL(url)};createUI();runAllTests()})();" class="btn btn-primary">üìå Right-click to Bookmark</a>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Browser Support</div>
            <p style="color: #cbd5e1; font-size: 12px; line-height: 1.6;">
                Works on all modern browsers: Chrome, Firefox, Safari, Edge. The bookmarklet runs entirely client-side with no external dependencies (except optional SheetJS for XLSX support).
            </p>
        </div>

        <div class="section">
            <div class="section-title">Need Help?</div>
            <div class="info-box">
                <strong>Troubleshooting:</strong> If the bookmarklet doesn't appear, try refreshing the page and clicking it again. Some browsers may require enabling JavaScript or adjusting security settings.
            </div>
        </div>

        <div class="button-group" style="margin-top: 32px;">
            <a href="https://github.com/linearpeanut/TableauTestSuite" class="btn btn-secondary">üìñ View Documentation</a>
            <a href="https://github.com/linearpeanut/TableauTestSuite/issues" class="btn btn-secondary">üêõ Report Issues</a>
        </div>
    </div>

    <script>
        // Auto-detect if user is trying to click the bookmark link directly
        document.querySelector('.btn-primary').addEventListener('click', function(e) {
            e.preventDefault();
            alert('Please right-click the button and select "Bookmark This Link" or "Add to Favorites" instead of clicking it directly.');
        });
    </script>
</body>
</html>